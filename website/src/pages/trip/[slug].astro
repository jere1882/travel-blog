---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const trips = await getCollection('trips');
  // Only generate pages for published trips
  const publishedTrips = trips.filter(trip => trip.data.publish !== false);
  return publishedTrips.map((trip) => ({
    params: { slug: trip.data.trip_id },
    props: { trip },
  }));
}

const { trip } = Astro.props;

// Get folder name for image paths
const folder = trip.id.split('/')[0];

// Transform Obsidian image syntax to standard HTML
// ![[image.jpg]] -> <img src="/images/folder/image.jpg" />
function transformObsidianImages(content: string, folder: string): string {
  // Transform ![[image.jpg]] to standard markdown
  return content.replace(
    /!\[\[([^\]]+)\]\]/g,
    (match, filename) => {
      // Handle image captions (text after the image on next line starting with *)
      const encodedFilename = encodeURIComponent(filename);
      return `![${filename}](/images/${folder}/${encodedFilename})`;
    }
  );
}

// Transform the markdown body
const transformedBody = transformObsidianImages(trip.body || '', folder);

// Render the transformed content
const { Content } = await render(trip);
---

<BaseLayout title={`${trip.data.title} | Jere's Travel Chronicles`}>
  <article class="trip-article">
    <header class="trip-header">
      <div class="container">
        <div class="trip-meta">
          <span class="trip-countries">{trip.data.countries.join(' · ')}</span>
          <span class="trip-dates">{trip.data.date_from === trip.data.date_to ? trip.data.date_from : `${trip.data.date_from} to ${trip.data.date_to}`}</span>
          <span class="trip-duration">{trip.data.duration}</span>
        </div>
        <h1 class="trip-title">{trip.data.title}</h1>
        {trip.data.cities && trip.data.cities.length > 0 && (
          <p class="trip-cities">{trip.data.cities.join(' → ')}</p>
        )}
        {trip.data.tags && trip.data.tags.length > 0 && (
          <div class="trip-tags">
            {trip.data.tags.map((tag: string) => (
              <a href={`/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`} class="trip-tag">
                {tag.replace(/_/g, ' ')}
              </a>
            ))}
          </div>
        )}
      </div>
    </header>
    
    <div class="container">
      <div class="trip-content" data-folder={folder}>
        <Content />
      </div>
    </div>
  </article>
</BaseLayout>

<style is:global>
  .trip-article {
    padding-bottom: 4rem;
  }
  
  .trip-header {
    text-align: center;
    padding: 3rem 0 2rem;
    border-bottom: 1px solid var(--color-border);
    margin-bottom: 3rem;
  }
  
  .trip-meta {
    font-family: var(--font-heading);
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 1rem;
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    flex-wrap: wrap;
  }
  
  .trip-title {
    font-size: 2.8rem;
    font-weight: 700;
    margin-bottom: 1rem;
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.2;
  }
  
  .trip-cities {
    font-family: var(--font-body);
    font-style: italic;
    color: var(--color-text-light);
    font-size: 1.1rem;
  }
  
  .trip-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 1.25rem;
  }
  
  .trip-tag {
    font-family: var(--font-heading);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.35rem 0.75rem;
    background: #f5f5f0;
    border: 1px solid #e5e5e0;
    border-radius: 3px;
    color: #888;
    transition: all 0.2s ease;
    text-decoration: none;
  }
  
  .trip-tag:hover {
    background: #c5a47e;
    border-color: #c5a47e;
    color: #fff;
  }
  
  .trip-content {
    max-width: 1100px; /* Wide content area like myfeetwillleadme.com */
    margin: 0 auto;
    padding: 0 2rem;
    font-size: 1.1rem; /* Larger body text */
    line-height: 1.85; /* More generous line height */
  }
  
  .trip-content h1 {
    font-size: 2.2rem;
    margin-top: 3rem;
    margin-bottom: 1.25rem;
    line-height: 1.3;
  }
  
  .trip-content h1:first-child {
    margin-top: 0;
  }
  
  .trip-content h2 {
    font-size: 1.8rem;
    margin-top: 3.5rem;
    margin-bottom: 1.25rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
    line-height: 1.3;
  }
  
  .trip-content h3 {
    font-size: 1.5rem;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    line-height: 1.3;
  }
  
  .trip-content h4 {
    font-size: 1.25rem;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }
  
  .trip-content p {
    margin-bottom: 1.5rem;
  }
  
  /* Reduce spacing before lists */
  .trip-content p + ul,
  .trip-content p + ol {
    margin-top: -0.75rem;
  }
  
  /* Reduce spacing around blockquotes - override paragraph margins */
  .trip-content p:has(+ blockquote) {
    margin-bottom: 0.5rem;
  }
  
  .trip-content blockquote + p {
    margin-top: 0.5rem;
  }
  
  .trip-content h2 + ul,
  .trip-content h2 + ol,
  .trip-content h3 + ul,
  .trip-content h3 + ol {
    margin-top: -0.5rem;
  }
  
  /* Responsive adjustments */
  @media (min-width: 1400px) {
    .trip-content {
      max-width: 1200px;
    }
  }
  
  @media (max-width: 768px) {
    .trip-content {
      font-size: 1rem;
      padding: 0 1rem;
    }
    
    .trip-content h1 {
      font-size: 1.75rem;
    }
    
    .trip-content h2 {
      font-size: 1.5rem;
    }
    
    .trip-content h3 {
      font-size: 1.25rem;
    }
  }
  
  .trip-content p + img,
  .trip-content h1 + img,
  .trip-content h2 + img,
  .trip-content h3 + img {
    margin-top: 0.75rem;
  }
  
  .trip-content img {
    width: 100%;
    height: auto;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 4px;
    margin-top: 0.75rem;
    margin-bottom: 1rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }
  
  .trip-content em {
    font-style: italic;
  }
  
  /* Image captions - standalone em tags (not inside paragraphs) */
  .trip-content p + em,
  .trip-content img + em,
  .trip-content > em {
    color: var(--color-text-light);
    font-size: 0.95rem;
    display: block;
    text-align: center;
    margin-top: -0.5rem;
    margin-bottom: 2rem;
    font-style: normal;
  }
  
  .trip-content ul, .trip-content ol {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
  }
  
  .trip-content li {
    margin-bottom: 0.25rem;
  }
  
  .trip-content blockquote {
    border-left: 3px solid var(--color-accent);
    padding-left: 1.5rem;
    margin: 0;
    padding-top: 0;
    padding-bottom: 0;
    font-style: italic;
    color: var(--color-text-light);
    white-space: pre-line;
    line-height: 1.4;
    display: table;
  }
  
  /* Travel Tip Boxes */
  .travel-tip {
    background: linear-gradient(135deg, #fff9e6 0%, #fff5d6 100%);
    border-left: 4px solid #f4c430;
    border-radius: 6px;
    padding: 1.25rem 1.5rem;
    margin: 2rem 0;
    box-shadow: 0 2px 8px rgba(244, 196, 48, 0.15);
  }
  
  .travel-tip-content {
    color: var(--color-text);
    font-family: var(--font-body);
    line-height: 1.7;
  }
  
  .travel-tip-content p {
    margin: 0 0 0.75rem 0;
  }
  
  .travel-tip-content p:last-child {
    margin-bottom: 0;
  }
  
  .travel-tip-content strong {
    color: var(--color-text);
    font-weight: 600;
  }
  
  .travel-tip-content a {
    color: var(--color-accent-dark);
    text-decoration: underline;
  }
  
  .travel-tip-content a:hover {
    color: var(--color-text);
  }
  
  .trip-content hr {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 3rem 0;
  }
  
  .trip-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.9rem;
  }
  
  .trip-content th, .trip-content td {
    padding: 0.75rem;
    border: 1px solid var(--color-border);
    text-align: left;
  }
  
  .trip-content th {
    background: var(--color-card-bg);
    font-family: var(--font-heading);
    font-weight: 600;
  }
  
  .trip-content a {
    color: var(--color-accent-dark);
    text-decoration: underline;
  }
  
  .trip-content a:hover {
    color: var(--color-text);
  }
  
  /* Carousel styles */
  .image-carousel {
    margin: 1.5rem 0;
    position: relative;
  }
  
  .carousel-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 4px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    background: #f9f9f9;
  }
  
  .carousel-slide {
    width: 100%;
    position: relative;
  }
  
  .carousel-slide img {
    width: 100%;
    height: auto;
    max-height: 90vh;
    object-fit: contain;
    display: block;
  }
  
  .carousel-caption {
    text-align: center;
    color: var(--color-text-light);
    font-size: 0.9rem;
    margin-top: 0.75rem;
    padding: 0 1rem 1rem;
    font-style: italic;
  }
  
  .carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    color: #333;
    line-height: 1;
  }
  
  .carousel-btn:hover {
    background: rgba(255, 255, 255, 1);
    transform: translateY(-50%) scale(1.1);
  }
  
  .carousel-btn:active {
    transform: translateY(-50%) scale(0.95);
  }
  
  .carousel-btn-prev {
    left: 10px;
  }
  
  .carousel-btn-next {
    right: 10px;
  }
  
  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 1rem;
  }
  
  .carousel-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: none;
    background: #ddd;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
  }
  
  .carousel-dot:hover {
    background: #999;
  }
  
  .carousel-dot.active {
    background: var(--color-accent, #c5a47e);
    width: 24px;
    border-radius: 5px;
  }
  
  .carousel-counter {
    text-align: center;
    color: var(--color-text-light);
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }
  
  @media (max-width: 768px) {
    .trip-header {
      padding: 2rem 0 1.5rem;
    }
    
    .trip-title {
      font-size: 1.8rem;
      padding: 0 1rem;
    }
    
    .trip-meta {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .carousel-btn {
      width: 32px;
      height: 32px;
      font-size: 20px;
    }
    
    .carousel-btn-prev {
      left: 5px;
    }
    
    .carousel-btn-next {
      right: 5px;
    }
    
    .carousel-caption {
      font-size: 0.85rem;
      padding: 0 0.75rem 0.75rem;
    }
  }
  
  @media (min-width: 769px) and (max-width: 1200px) {
    .trip-content {
      max-width: 90%;
    }
  }
  
  /* Table of Contents */
  .table-of-contents {
    background: #f9f9f9;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 1.5rem 2rem;
    margin: 2.5rem 0;
  }
  
  .toc-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    color: var(--color-text);
    border: none;
    padding: 0;
  }
  
  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .toc-item {
    margin-bottom: 0.5rem;
    line-height: 1.6;
  }
  
  .toc-item.toc-level-1 {
    font-weight: 700;
    margin-left: 1rem;
    font-size: 1.15rem;
    margin-bottom: 0.75rem;
    margin-top: 0.5rem;
    color: var(--color-text);
  }
  
  .toc-item.toc-level-1:first-child {
    margin-top: 0;
  }
  
  .toc-item.toc-level-2 {
    font-weight: 600;
    margin-left: 2rem;
    font-size: 1rem;
    margin-bottom: 0.4rem;
  }
  
  .toc-item.toc-level-3 {
    font-weight: 400;
    margin-left: 3rem;
    font-size: 0.95rem;
    margin-bottom: 0.35rem;
  }
  
  .toc-item.toc-level-4 {
    font-weight: 400;
    margin-left: 4.5rem;
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
  }
  
  .toc-item a {
    color: var(--color-text);
    text-decoration: none;
    transition: color 0.2s ease;
    display: inline-block;
  }
  
  .toc-item.toc-level-1 a {
    color: var(--color-text);
  }
  
  .toc-item.toc-level-2 a {
    color: var(--color-text);
  }
  
  .toc-item a:hover {
    color: var(--color-accent-dark, #c5a47e);
    text-decoration: underline;
  }
  
  @media (max-width: 768px) {
    .table-of-contents {
      padding: 1.25rem 1.5rem;
      margin: 2rem 0;
    }
    
    .toc-title {
      font-size: 1.15rem;
    }
    
    .toc-item.toc-level-1 {
      font-size: 1.05rem;
      margin-left: 0.5rem;
    }
    
    .toc-item.toc-level-2 {
      font-size: 0.95rem;
      margin-left: 1.25rem;
    }
    
    .toc-item.toc-level-3 {
      margin-left: 2rem;
      font-size: 0.9rem;
    }
    
    .toc-item.toc-level-4 {
      margin-left: 3rem;
      font-size: 0.85rem;
    }
  }
</style>

<script define:vars={{ folder }}>
  // Transform Obsidian image syntax in the rendered content
  document.querySelectorAll('.trip-content p').forEach(p => {
    const html = p.innerHTML;
    // Match ![[filename.ext]] pattern
    const transformed = html.replace(
      /!\[\[([^\]]+)\]\]/g,
      (match, filename) => {
        const encodedFilename = encodeURIComponent(filename);
        return `<img src="/images/${folder}/${encodedFilename}" alt="${filename}" loading="lazy" />`;
      }
    );
    if (transformed !== html) {
      p.innerHTML = transformed;
    }
  });
  
  // Process carousels
  function processCarousels() {
    const content = document.querySelector('.trip-content');
    if (!content) return;
    
    const paragraphs = Array.from(content.querySelectorAll('p'));
    let inCarousel = false;
    let carouselImages = [];
    let carouselStart = null;
    let elementsToRemove = [];
    
    paragraphs.forEach((p, index) => {
      const text = p.textContent?.trim() || '';
      const html = p.innerHTML?.trim() || '';
      
      // Check for carousel start marker (in text or HTML)
      if (text === '[carousel]' || html === '[carousel]' || html.includes('[carousel]')) {
        inCarousel = true;
        carouselStart = p;
        carouselImages = [];
        elementsToRemove = [p];
        return;
      }
      
      // Check for carousel end marker (in text or HTML)
      if ((text === '[/carousel]' || html === '[/carousel]' || html.includes('[/carousel]')) && inCarousel) {
        if (carouselImages.length > 0 && carouselStart) {
          createCarousel(carouselStart, carouselImages);
        }
        elementsToRemove.push(p);
        // Remove all carousel-related elements
        elementsToRemove.forEach(el => el.remove());
        inCarousel = false;
        carouselStart = null;
        carouselImages = [];
        elementsToRemove = [];
        return;
      }
      
      // Collect images and captions within carousel
      if (inCarousel) {
        const img = p.querySelector('img');
        if (img) {
          // Get caption - first check same paragraph, then next paragraph
          let caption;
          
          // Check if caption is in the same paragraph (after the image)
          const emInSame = p.querySelector('em');
          if (emInSame) {
            caption = emInSame.textContent?.trim();
          } else {
            // Check next paragraph for caption
            const nextP = paragraphs[index + 1];
            if (nextP && !nextP.querySelector('img')) {
              const em = nextP.querySelector('em');
              if (em) {
                caption = em.textContent?.trim();
                // Remove the caption paragraph from normal flow
                if (!elementsToRemove.includes(nextP)) {
                  elementsToRemove.push(nextP);
                }
              }
            }
          }
          
          carouselImages.push({
            src: img.getAttribute('src') || '',
            alt: img.getAttribute('alt') || '',
            caption: caption
          });
          
          // Mark this paragraph for removal
          if (!elementsToRemove.includes(p)) {
            elementsToRemove.push(p);
          }
        }
      }
    });
  }
  
  function createCarousel(insertBefore, images) {
    // Create carousel container
    const carousel = document.createElement('div');
    carousel.className = 'image-carousel';
    
    const container = document.createElement('div');
    container.className = 'carousel-container';
    
    const slide = document.createElement('div');
    slide.className = 'carousel-slide';
    
    const img = document.createElement('img');
    img.src = images[0].src;
    img.alt = images[0].alt;
    img.loading = 'lazy';
    slide.appendChild(img);
    
    if (images[0].caption) {
      const caption = document.createElement('p');
      caption.className = 'carousel-caption';
      caption.textContent = images[0].caption;
      slide.appendChild(caption);
    }
    
    // Navigation buttons
    if (images.length > 1) {
      // Navigation state
      let currentIndex = 0;
      
      function goToSlide(index) {
        currentIndex = index;
        const slideEl = carousel.querySelector('.carousel-slide');
        const imgEl = slideEl.querySelector('img');
        const captionEl = slideEl.querySelector('.carousel-caption');
        
        imgEl.src = images[index].src;
        imgEl.alt = images[index].alt;
        
        if (images[index].caption) {
          if (!captionEl) {
            const newCaption = document.createElement('p');
            newCaption.className = 'carousel-caption';
            slideEl.appendChild(newCaption);
          }
          slideEl.querySelector('.carousel-caption').textContent = images[index].caption;
        } else if (captionEl) {
          captionEl.remove();
        }
        
        // Update dots
        carousel.querySelectorAll('.carousel-dot').forEach((dot, i) => {
          dot.classList.toggle('active', i === index);
        });
        
        // Update counter
        carousel.querySelector('.carousel-counter').textContent = `${index + 1} / ${images.length}`;
      }
      
      const prevBtn = document.createElement('button');
      prevBtn.className = 'carousel-btn carousel-btn-prev';
      prevBtn.setAttribute('aria-label', 'Previous');
      prevBtn.textContent = '‹';
      prevBtn.addEventListener('click', () => {
        const newIndex = (currentIndex - 1 + images.length) % images.length;
        goToSlide(newIndex);
      });
      container.appendChild(prevBtn);
      
      const nextBtn = document.createElement('button');
      nextBtn.className = 'carousel-btn carousel-btn-next';
      nextBtn.setAttribute('aria-label', 'Next');
      nextBtn.textContent = '›';
      nextBtn.addEventListener('click', () => {
        const newIndex = (currentIndex + 1) % images.length;
        goToSlide(newIndex);
      });
      container.appendChild(nextBtn);
      
      // Dots navigation
      const dots = document.createElement('div');
      dots.className = 'carousel-dots';
      images.forEach((_, i) => {
        const dot = document.createElement('button');
        dot.className = `carousel-dot ${i === 0 ? 'active' : ''}`;
        dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
        dot.addEventListener('click', () => goToSlide(i));
        dots.appendChild(dot);
      });
      carousel.appendChild(dots);
      
      // Counter
      const counter = document.createElement('div');
      counter.className = 'carousel-counter';
      counter.textContent = `1 / ${images.length}`;
      carousel.appendChild(counter);
    }
    
    container.appendChild(slide);
    carousel.appendChild(container);
    
    // Insert before the start marker
    insertBefore.parentNode.insertBefore(carousel, insertBefore);
  }
  
  // Process table of contents
  function processTableOfContents() {
    const content = document.querySelector('.trip-content');
    if (!content) return;
    
    // Find TOC marker
    const paragraphs = Array.from(content.querySelectorAll('p'));
    let tocMarker = null;
    
    paragraphs.forEach((p) => {
      const text = p.textContent?.trim() || '';
      if (text === '[content_table]' || text === '[toc]') {
        tocMarker = p;
      }
    });
    
    if (!tocMarker) return;
    
    // Get all headings (h1, h2 only) in the content
    const allHeadings = Array.from(content.querySelectorAll('h1, h2'));
    const headings = [];
    
    // Find headings that come after the TOC marker using compareDocumentPosition
    for (const heading of allHeadings) {
      // Check if heading comes after the marker in document order
      const position = tocMarker.compareDocumentPosition(heading);
      const isAfter = (position & Node.DOCUMENT_POSITION_FOLLOWING) !== 0;
      
      if (isAfter) {
        // Ensure heading has an ID for anchor links
        if (!heading.id) {
          const text = heading.textContent || '';
          heading.id = text.toLowerCase()
            .replace(/[^\w\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .trim();
        }
        
        const tagName = heading.tagName?.toLowerCase();
        headings.push({
          level: parseInt(tagName.charAt(1)),
          text: heading.textContent || '',
          id: heading.id
        });
      }
    }
    
    if (headings.length === 0) {
      tocMarker.remove();
      return;
    }
    
    // Create TOC container
    const tocContainer = document.createElement('div');
    tocContainer.className = 'table-of-contents';
    
    const tocTitle = document.createElement('h3');
    tocTitle.className = 'toc-title';
    tocTitle.textContent = 'Table of Contents';
    tocContainer.appendChild(tocTitle);
    
    const tocList = document.createElement('ul');
    tocList.className = 'toc-list';
    
    headings.forEach((heading) => {
      const tocItem = document.createElement('li');
      tocItem.className = `toc-item toc-level-${heading.level}`;
      
      const tocLink = document.createElement('a');
      tocLink.href = `#${heading.id}`;
      tocLink.textContent = heading.text;
      tocLink.addEventListener('click', (e) => {
        e.preventDefault();
        const target = document.getElementById(heading.id);
        if (target) {
          const offset = 80; // Account for fixed headers if any
          const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - offset;
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
        }
      });
      
      tocItem.appendChild(tocLink);
      tocList.appendChild(tocItem);
    });
    
    tocContainer.appendChild(tocList);
    
    // Replace marker with TOC
    tocMarker.parentNode.replaceChild(tocContainer, tocMarker);
  }
  
  // Run after initial image processing
  setTimeout(() => {
    processCarousels();
    processTableOfContents();
  }, 100);
  
  // Also run on view transitions
  document.addEventListener('astro:after-swap', () => {
    setTimeout(() => {
      processCarousels();
      processTableOfContents();
    }, 100);
  });
</script>

